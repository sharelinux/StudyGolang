## 费曼笔记 ##
### 错误处理（上）

#### 基础概念

> 卫述语句: 卫述语句是指被用来检查关键的先决条件的合法性并在检查未通过的情况下立即终止当前代码块的执行的语句。简单地讲，它就是被用来检查后续操作的前置条件并进行相应处理的语句。
if语句常被作为卫述语句。

> 错误指的是可能出现问题的地方出现了问题，比如打开一个文件时失败，这种情况在人们的意料之中;

> 异常指的是不应该出现问题的地方出现了问题，比如引用了空指针，这种情况在人们的意料之外; 错误是业务过程的一部分，而异常不是.

error类型其实是一个接口类型，也是一个 Go 语言的内建类型。在这个接口类型的声明中只包含了一个方法Error。这个方法不接受任何参数，但是会返回一个string类型的结果.

它的作用是返回错误信息的字符串表示形式。我们使用error类型的方式通常是，在函数声明的结果列表的最后，声明一个该类型的结果，同时在调用这个函数之后，先判断它返回的最后一个结果值是否“不为nil”.

当我们想通过模板化的方式生成错误信息，并得到错误值时，可以使用fmt.Errorf函数。该函数所做的其实就是先调用fmt.Sprintf函数，得到确切的错误信息；再调用errors.New函数，得到包含该错误信息的error类型值，最后返回该值。


#### 思考问题
##### 问题1 对于具体错误的判断，Go 语言中都有哪些惯用法？怎样判断一个错误值具体代表的是哪一类错误？
1. 对于类型在已知范围内的一系列错误值，一般使用类型断言表达式或类型switch语句来判断；
2. 对于已有相应变量且类型相同的一系列错误值，一般直接使用判等操作来判断；
3. 对于没有相应变量且类型未知的一系列错误值，只能使用其错误信息的字符串表示形式来做判断。

#### 总结
错误处理: 如果函数要返回错误，则返回值类型列表中肯定包含error。error处理过程类似于C语言中的错误码，可逐层返回，直到被处理。


##### Golang错误和异常是可以互相转换的
1. 错误转异常，比如程序逻辑上尝试请求某个URL，最多尝试三次，尝试三次的过程中请求失败是错误，尝试完第三次还不成功的话，失败就被提升为异常了。
2. 异常转错误，比如panic触发的异常被recover恢复后，将返回值中error类型的变量进行赋值，以便上层函数继续走错误处理流程。


##### 错误处理的正确姿势
1. 失败原因只有一个，不是用error类型，而使用bool类型;
2. 没有失败时，不适用error类型返回; 例如: 某个结构体的指针set设置某字段方法；
3. error应放在返回值类型列表的最后;
4. 错误值统一定义，而不是跟着感觉走; 尤其使用errors.New(value)字符错误方法是需要统一规划
  ```go
  var ERR_EOF = errors.New("EOF")
  var ERR_CLOSED_PIPE = errors.New("io: read/write on closed pipe")
  var ERR_NO_PROGRESS = errors.New("multiple Read calls return no data or error")
  var ERR_SHORT_BUFFER = errors.New("short buffer")
  var ERR_SHORT_WRITE = errors.New("short write")
  var ERR_UNEXPECTED_EOF = errors.New("unexpected EOF")
  ```
5. 错误逐层传递时，层层都加日志；
6. 错误处理使用defer；如果当前操作失败，需要将本函数中已经create的资源destroy掉；
7. 当尝试几次可以避免失败时，不要立即返回错误;

    如果错误的发生是偶然性的，或由不可预知的问题导致。一个明智的选择是重新尝试失败的操作，有时第二次或第三次尝试时会成功。在重试时，我们需要限制重试的时间间隔或重试的次数，防止无限制的重试。

8. 当上层函数不关心错误时，建议不返回error;

    对于一些资源清理相关的函数（destroy/delete/clear），如果子函数出错，打印日志即可，而无需将错误进一步反馈到上层函数，因为一般情况下，上层函数是不关心执行结果的，或者即使关心也无能为力，于是我们建议将相关函数设计为不返回error。

9. 当发生错误时，不忽略有用的返回值;

    通常，当函数返回non-nil的error时，其他的返回值是未定义的(undefined)，这些未定义的返回值应该被忽略。然而，有少部分函数在发生错误时，仍然会返回一些有用的返回值。比如，当读取文件发生错误时，Read函数会返回可以读取的字节数以及错误信息。对于这种情况，应该将读取到的字符串和错误信息一起打印出来。


参考: https://www.jianshu.com/p/f30da01eea97

参考: https://tonybai.com/2015/10/30/error-handling-in-go/